---
layout: post
title: OData
---


Concept
----------------------------------------

[Open Data Protocol](http://www.odata.org/documentation/odata-version-2-0/) is an application-level protocol for interacting with data via RESTful web services.

Based on Web technologies such as **HTTP**, Atom Publishing Protocal (**AtomPub**) and **JSON**

The OData Protocol is __different__ from other REST-based web service approaches in that it provides a __uniform__ way to describe both the __data__ and the __data model__. This improves semantic interoperability between systems and allows an ecosystem to emerge.


* **Uniform** way of representing structured data
    * Atom, JSON formats
* **Uniform** URI conventions
    * Navigation, filtering, sorting, paging, et.
* **Uniform** operations
    * Addressability
    * GET, POST, PUT, DELETE always mean the same


### RESTful

Resources are __nouns__. The first base URL is for **collections**, the second is for a specific element in the collection.

Common RESTful web service

    /dogs
    /dogs/1234

OData web service

    /Dogs
    /Dogs(1234)


Use HTTP __verbs__ to operate on the collections and elements.

* GET == SELECT
* POST == INSERT
* PUT == UPDATE
* DELETE == DELETE

#### Example

![REST CRUD](https://blog.apigee.com/sites/blog/files/Prag_REST_CRUD_thumb.png)


### AtomPub

Atom is an __XML-based__ document format that describes lists of related information known as "__feeds__".

Feeds are composed of a number of items, known as "__entries__".

The "__atom:entry__" element represents an individual entry, acting as a container for metadata and data associated with the entry.

#### ATOM Example

    TODO


### JSON

Request Header

    Accept: application/json


#### Representing Collections of Entries

    {
        "d": {
            "results": [
                { ... },
                { ... },
                { ... }
            ]
        }
    }

#### Primitive Data Types


    Primitive Type      JSON Serialization Format
    ------------------------------------------------------------------------------------------------
    Edm.Binary          "X('24AB')" - Base64 encoded value represented as a JSON string
    Edm.Boolean         true | false
    Edm.Byte            "FF"
    Edm.DateTime        "/Date(694224000000)/" - number of milliseconds since midnight Jan 1, 1970
    Edm.Decimal         "2.345"
    Edm.Double          "2.029"
    Edm.Guid            "guid'12345678-aaaa-bbbb-cccc-ddddeeeeffff'"
    Edm.Int16           123
    Edm.Int32           123
    Edm.Int64           "123456"
    Edm.Single          "123.456"
    Edm.String          "string"
    Edm.Time            "13:20:00"
    Edm.DateTimeOffset  "2002-10-10T17:00:00Z"



URL Conventions
----------------------------------------

Uniform Service Interface

![OData URI Protocol](http://www.odata.org/wp-content/uploads/ODataUri.png)

    http://services.odata.org/OData/OData.svc
    ________________________________________/
                   |
            service root URL

    http://services.odata.org/OData/OData.svc/Categories(1)/Products?$top=2&$orderby=Name
    ________________________________________/ _____________________/ ___________________/
                   |                                   |                    |
             service root URL                     resource path        query options


    http://10.58.185.121:8000/sap/tam/xs/rest/odata.xsodata/Regions('USA')/Zones?$top=10&$skip=10
    ______________________________________________________/ ___________________/ _______________/
                   |                                              |                    |
            service root URL                                resource path        query options


#### Example

Entity set

    /Bookmarks

Single entity

    /Bookmarks('123')

Property access

    /Bookmarks('123')/Name

Link traversal

    /Bookmarks('123')/Tags

Deep access

    /Bookmarks('123')/Tags('abc')/Name

Sorting

    /Bookmarks?$orderby=Name

Filtering

    /Bookmarks?$filter=Created gt '2012-03-09'

Paging

    /Bookmarks?$top=10&$skip=30


Produce OData Service - XS Engine
----------------------------------------

### Service Document

    GET http://services.odata.org/V2/OData/OData.svc

Response

    <?xml version="1.0" encoding="utf-8" standalone="yes"?>
    <service xml:base="http://services.odata.org/V2/OData/OData.svc/" 
        xmlns:atom="http://www.w3.org/2005/Atom" 
        xmlns:app="http://www.w3.org/2007/app" 
        xmlns="http://www.w3.org/2007/app">
        <workspace>
            <atom:title>Default</atom:title>
            <collection href="Products">
                <atom:title>Products</atom:title>
            </collection>
            <collection href="Categories">
                <atom:title>Categories</atom:title>
            </collection>
            <collection href="Suppliers">
                <atom:title>Suppliers</atom:title>
            </collection>
        </workspace>
    </service>


### Metadata

__Entity Data Model (EDM)__ is the underlying abstract data model used by OData services to formalize the description of the resources it exposes. The central concepts in the EDM are entities and associations.

All data service may also expose a Service Metadata Document that describes the data model. Service Metadata Document is a a machine-readable description of the data model exposed by a particular data provider.


    GET http://10.58.185.121:8000/sap/tam/xs/rest/odata.xsodata/$metadata


#### Example

    GET http://services.odata.org/V2/OData/OData.svc/$metadata

Response

    <?xml version="1.0" encoding="utf-8" standalone="yes"?>
    <edmx:Edmx Version="1.0" 
        xmlns:edmx="http://schemas.microsoft.com/ado/2007/06/edmx">
        <edmx:DataServices 
            xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" m:DataServiceVersion="2.0">
            <Schema Namespace="ODataDemo" 
                xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" 
                xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" 
                xmlns="http://schemas.microsoft.com/ado/2007/05/edm">
                <EntityType Name="Product">
                    <Key>
                        <PropertyRef Name="ID" />
                    </Key>
                    <Property Name="ID" Type="Edm.Int32" Nullable="false" />
                    <Property Name="Name" Type="Edm.String" Nullable="true" m:FC_TargetPath="SyndicationTitle" m:FC_ContentKind="text" m:FC_KeepInContent="false" />
                    <Property Name="Description" Type="Edm.String" Nullable="true" m:FC_TargetPath="SyndicationSummary" m:FC_ContentKind="text" m:FC_KeepInContent="false" />
                    <Property Name="ReleaseDate" Type="Edm.DateTime" Nullable="false" />
                    <Property Name="DiscontinuedDate" Type="Edm.DateTime" Nullable="true" />
                    <Property Name="Rating" Type="Edm.Int32" Nullable="false" />
                    <Property Name="Price" Type="Edm.Decimal" Nullable="false" />
                    <NavigationProperty Name="Category" Relationship="ODataDemo.Product_Category_Category_Products" FromRole="Product_Category" ToRole="Category_Products" />
                    <NavigationProperty Name="Supplier" Relationship="ODataDemo.Product_Supplier_Supplier_Products" FromRole="Product_Supplier" ToRole="Supplier_Products" />
                </EntityType>
                <EntityType Name="Category">
                    <Key>
                        <PropertyRef Name="ID" />
                    </Key>
                    <Property Name="ID" Type="Edm.Int32" Nullable="false" />
                    <Property Name="Name" Type="Edm.String" Nullable="true" m:FC_TargetPath="SyndicationTitle" m:FC_ContentKind="text" m:FC_KeepInContent="true" />
                    <NavigationProperty Name="Products" Relationship="ODataDemo.Product_Category_Category_Products" FromRole="Category_Products" ToRole="Product_Category" />
                </EntityType>
                <EntityType Name="Supplier">
                    <Key>
                        <PropertyRef Name="ID" />
                    </Key>
                    <Property Name="ID" Type="Edm.Int32" Nullable="false" />
                    <Property Name="Name" Type="Edm.String" Nullable="true" m:FC_TargetPath="SyndicationTitle" m:FC_ContentKind="text" m:FC_KeepInContent="true" />
                    <Property Name="Address" Type="ODataDemo.Address" Nullable="false" />
                    <Property Name="Concurrency" Type="Edm.Int32" Nullable="false" ConcurrencyMode="Fixed" />
                    <NavigationProperty Name="Products" Relationship="ODataDemo.Product_Supplier_Supplier_Products" FromRole="Supplier_Products" ToRole="Product_Supplier" />
                </EntityType>
                <ComplexType Name="Address">
                    <Property Name="Street" Type="Edm.String" Nullable="true" />
                    <Property Name="City" Type="Edm.String" Nullable="true" />
                    <Property Name="State" Type="Edm.String" Nullable="true" />
                    <Property Name="ZipCode" Type="Edm.String" Nullable="true" />
                    <Property Name="Country" Type="Edm.String" Nullable="true" />
                </ComplexType>
                <Association Name="Product_Category_Category_Products">
                    <End Role="Product_Category" Type="ODataDemo.Product" Multiplicity="*" />
                    <End Role="Category_Products" Type="ODataDemo.Category" Multiplicity="0..1" />
                </Association>
                <Association Name="Product_Supplier_Supplier_Products">
                    <End Role="Product_Supplier" Type="ODataDemo.Product" Multiplicity="*" />
                    <End Role="Supplier_Products" Type="ODataDemo.Supplier" Multiplicity="0..1" />
                </Association>
                <EntityContainer Name="DemoService" m:IsDefaultEntityContainer="true">
                    <EntitySet Name="Products" EntityType="ODataDemo.Product" />
                    <EntitySet Name="Categories" EntityType="ODataDemo.Category" />
                    <EntitySet Name="Suppliers" EntityType="ODataDemo.Supplier" />
                    <AssociationSet Name="Products_Category_Categories" Association="ODataDemo.Product_Category_Category_Products">
                        <End Role="Product_Category" EntitySet="Products" />
                        <End Role="Category_Products" EntitySet="Categories" />
                    </AssociationSet>
                    <AssociationSet Name="Products_Supplier_Suppliers" Association="ODataDemo.Product_Supplier_Supplier_Products">
                        <End Role="Product_Supplier" EntitySet="Products" />
                        <End Role="Supplier_Products" EntitySet="Suppliers" />
                    </AssociationSet>
                    <FunctionImport Name="GetProductsByRating" EntitySet="Products" ReturnType="Collection(ODataDemo.Product)" m:HttpMethod="GET">
                        <Parameter Name="rating" Type="Edm.Int32" Mode="In" />
                    </FunctionImport>
                </EntityContainer>
            </Schema>
        </edmx:DataServices>
    </edmx:Edmx>


### EDM

* EntityTypes - data model definitions
* Entities - instances of Entity types
* Entity Key - primary key either single or composite
* Associations - define the relationship between two or more Entity Types
* Navigation Properties - special properties on Entity Types which are bound to a specific association and can be used to refer to associations of an entity


### Navigation Property

    http://services.odata.org/V2/OData/OData.svc/Categories(1)/Products(2)

Same as

    http://services.odata.org/V2/OData/OData.svc/Products(2)


Consume OData Service - UI5
----------------------------------------

### Proxy

### Usage

JSONModel

                                            Controller  --->    Web Service     <---    Java    <---    Database
                                                \_ generate URL     |
                                                                    |
    UI Control  <---    JSONModel   <---    Controller  <----------/
                                                \_ transform response data


ODataModel

    UI Control  --->    ODataModel  --->    OData Service   <---    xsodata     <---    Database
    UI Control  <---    ODataModel  <-----------|


### Data Binding

#### JSONModel - Client-side Data Model, Offline Dataset

Test.view.xml

    <DropdownBox id="dropdownbox" items="{/locations}">
        <core:ListItem key="{ID}" text="{NAME}"></core:ListItem>
    </DropdownBox>


Test.controller.js

    // Create a JSON model
    var jsonModel = new sap.ui.model.json.JSONModel();
    jsonModel.setData({
        locations: []
    });
    sap.ui.getCore().setModel(jsonModel);

    // Create a DropdownBox
    var dropdownbox = new sap.ui.commons.DropdownBox("dropdownbox");
    dropdownbox.plactAt("content");

    // data binding
    var itemTempl = new sap.ui.core.ListItem();
    itemTempl.bindProperty("key", "ID");
    itemTempl.bindProperty("text", "NAME");
    dropdownbox.bindItems("/locations", itemTempl);

    // get data from service
    jQuery.getJSON('service/Locations', function(data) {
        var items = data.results;

        // transform service data to client data
        Utils.each(items, function(item) {
            item.ID = item.CODE;
            item.NAME = item.CODE_NAME;
        });

        // update model
        jsonModel.setProperty("/locations", items);
    });


Get a property by a given JSON object path.

    var name = jsonModel.getProperty("NAME", "/locations/0");

Or get the whole model data and drill down.

    var data = jsonModel.getData();
    var name = data.locations[0].NAME;


#### ODataModel - Server-side Data Model, Online Dataset

The ODataModel enables binding of controls to data from OData services. The ODataModel is a server-side model, __so the whole dataset is only available on the server, the client only knows the currently visible rows and fields__. This also means sorting and filtering on the client is not possible, the client has to send a request to the server to accomplish these tasks.

Test.view.xml

    <DropdownBox id="combobox" items="{/DateFormats}" selectedKey="{DATE_FORMATE_ID}">
        <core:ListItem key="{ID}" text="{FORMAT}"></core:ListItem>
    </DropdownBox>

Test.controller.js

    // Create a OData model
    var odataModel = new sap.ui.model.odata.ODataModel("../xs/rest/odata.xsodata", true, "system", "Abcd1234");
    sap.ui.getCore().setModel(odataModel);

    // Create a DropdownBox
    var dropdownbox = new sap.ui.commons.DropdownBox("dropdownbox");
    dropdownbox.plactAt("content");

    // data binding
    var itemTempl = new sap.ui.core.ListItem();
    itemTempl.bindProperty("key", "ID");
    itemTempl.bindProperty("text", "NAME");
    dropdownbox.bindItems("/Locations", itemTempl);


Get a property by a given OData context path.

    var name = odataModel.getProperty("NAME", "/Locations('abc')");


### Why XS Engine OData + UI5 Sucks

* OData is fine - advanced RESTful service
* XS Engine provides poor middle layer
* UI5 put every work into ODataModel
* Thus, highly relay on good data modeling
* Simpler design, however sacrifice flexibility, difficult to do complicated logic.


Work Model
----------------------------------------

### Service API Document

    ui/doc/service.md

### Unit Test + JSON Schema Validator

    http://cnpvg50809797vm10.dhcp.pvgl.sap.corp:8080/tam-web/test-resources/ui/service/testsuite.qunit.html

### OData Mock Server

    Researching

### Work Model

1. UI Dev writes OData Service API spec.
2. UI Dev writes OData Service API unit test.
3. UI Dev creates mock service data and passes unit test (running OData Mock Server).
4. OData Dev implements OData Service API based on spec.
5. OData Dev valiates OData Service API by running unit test.
6. UI Dev integrates OData API into UI.

Best Practices
----------------------------------------

### Resource Path

* Entity set name should be a plural noun.


    /Products


* Entity set name in _PascalCase_


    /DepotManagers


### Property

* Meaningful and straightforward naming

Example 1: Location table in database

    {
        "CODE": "USA",
        "CODE_NAME": "United States of America",
        "CODE_DESC": "It is a country"
    }

The `/Locations` OData service is better to be:

    {
        "ID": "USA",
        "NAME": "United States of America",
        "DESC": "It is a country"
    }

Example 2: Role table in database

    {
        "ROLE_HEADER_ID": "123456",
        "ROLE_HEADER_NAME": "role 1",
        "ROLE_HEADER_DESC": "role 1 description"
    }

The `/Roles` OData service is better to be:

    {
        "ID": "123456",
        "NAME": "role 1",
        "DESC": "role 1 description"
    }


* Try to use `string` data type for primary key

To deal with big data, huge table. Many systems use GUID for primary keys.


* Entity Property in *UPPER_CASE* (due to XS Engine)

Common RESTful Protocol - *lower_case*

    id, name, zip_code

OData Protocol - *PascalCase*

    ID, Name, ZipCode

XS Engine, consist with DB Table - *UPPER_CASE*

    ID, NAME, ZIP_CODE


### Navigation Property

* Navigation Property in *PascalCase*

Because navigation property is in fact a link to another entity set.

    /DepotManagers(1)/Locations


* Navigation property name should be consistent to its real meaning.

One Product has only one Category

    /Products(1)/Category

It will navigate to a single Category entity.

    /Categories(1)


One Category has one or more Products

    /Categories(1)/Products


* Use `over ... principal ... dependent` to define association

`odata.xsodata`

    "sap.tam.db.basis::v_brand" as "Brands" key ("ID");

    "sap.tam.db.basis::v_brand_role" as "BrandRoles" key ("ID")
        navigates ("BrandRole_Brands" as "Brands");

    association "BrandRole_Brands"
        principal "BrandRoles"("ID") multiplicity "1"
        dependent "Brands"("ID") multiplicity "*"
        over "sap.tam.db.basis::t_brand_role" principal ("BRAND_ROLE_HEADER_ID") dependent ("BRAND_ID");

